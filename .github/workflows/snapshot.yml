name: Create snapshot release

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest successful workflow run
        id: get_run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          run_id=$(gh run list \
            --workflow=build.yml \
            --branch=master \
            --status=success \
            --limit=1 \
            --json databaseId \
            --jq '.[0].databaseId')
          
          if [ -z "$run_id" ] || [ "$run_id" = "null" ]; then
            echo "No successful workflow runs found"
            exit 1
          fi
          
          echo "run_id=$run_id" >> $GITHUB_OUTPUT
          
          commit_sha=$(gh run view "$run_id" --json headSha --jq '.headSha')
          echo "commit_sha=$commit_sha" >> $GITHUB_OUTPUT
          echo "short_sha=${commit_sha:0:7}" >> $GITHUB_OUTPUT

      - name: Check if release already exists for this commit
        id: check_release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          latest_release_tag=$(gh release list \
            --limit=1 \
            --json tagName \
            --jq '.[0].tagName // empty')
          
          if [ -z "$latest_release_tag" ]; then
            echo "No existing releases found"
            echo "should_release=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Get the commit SHA that the latest release tag points to
          latest_release_sha=$(git rev-list -n 1 "$latest_release_tag" 2>/dev/null || echo "")
          
          if [ -z "$latest_release_sha" ]; then
            echo "Could not find commit for tag $latest_release_tag"
            echo "should_release=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Latest release tag: $latest_release_tag"
          echo "Latest release SHA: $latest_release_sha"
          echo "Current build SHA: ${{ steps.get_run.outputs.commit_sha }}"
          
          if [ "$latest_release_sha" = "${{ steps.get_run.outputs.commit_sha }}" ]; then
            echo "No changes since last release"
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "New changes detected"
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

      - name: Download artifacts
        if: steps.check_release.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p artifacts
          gh run download ${{ steps.get_run.outputs.run_id }} --dir artifacts

      - name: Compress artifacts
        if: steps.check_release.outputs.should_release == 'true'
        run: |
          mkdir -p release
          cd artifacts
          for dir in */; do
            name="${dir%/}"
            zip -r "../release/${name}.zip" "$dir"
          done

      - name: Generate release tag
        if: steps.check_release.outputs.should_release == 'true'
        id: tag
        run: |
          tag="snapshot-$(date -u +%Y%m%d-%H%M%S)-${{ steps.get_run.outputs.short_sha }}"
          echo "tag=$tag" >> $GITHUB_OUTPUT

      - name: Create Release
        if: steps.check_release.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ steps.tag.outputs.tag }}" \
            --title "${{ steps.tag.outputs.tag }}" \
            --notes "Automated snapshot release from commit ${{ steps.get_run.outputs.commit_sha }}" \
            --prerelease \
            --target ${{ steps.get_run.outputs.commit_sha }} \
            release/*.zip